---
title: "Setting Up a Virtual Malware Analysis Lab"
date: 2025-10-06 19:00:00
categories: [cybersecurity-labs]
tag: [Flare-vm, Malware Analysis]
author: Aisha
---


## Introduction

In this lab, we will build a safe and controlled virtual environment for malware analysis using **VirtualBox** and a **Windows 10 virtual machine**. The goal is to configure an isolated system where malware samples can be executed and studied without risking the host machine.

The setup process involves several key steps:

- Installing and configuring VirtualBox with a Windows 10 ISO.
- Taking snapshots to preserve clean states and allow easy rollbacks.
- Disabling Windows Defender and related security features that may interfere with malware execution.
- Install **FLARE‑VM** and the recommended analysis toolset (Procmon, Process Hacker, Sysmon, FakeNet, Wireshark, etc.).
- Perform a controlled dynamic execution of a malware sample to **validate the lab setup** and capture process, registry, file, and network artifacts.

> This tutorial is part of the *Building Malware Analysis Lab* module in the [**Malware Analysis**](https://app.letsdefend.io/path/malware-analysis-skill-path) learning path on **LetsDefend.**


## Setting up a virtual lab

1. **Download [Oracle VirtualBox](https://www.virtualbox.org/wiki/Downloads)**. If you have it installed, make sure it is updated to reduce the risk of malware escaping. 
2. **Download the Windows 10 ISO file**. First, download the [Windows 10 installation media](https://www.microsoft.com/en-us/software-download/windows10#:~:text=Create%20Windows%2010%20installation%20media). 
Once it finishes downloading, double-click it and choose **Create installation media**.
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-1.webp)
    
    For the language, architecture, and edition, select the recommended options.
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-2.webp)
    
    Then choose the ISO file and click Next
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-3.webp)
    
    Save the `.iso` file to a separate drive to avoid issues when configuring VirtualBox.
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-4.webp)
    
    Wait for the download to complete, then click **Finish**. The ISO is now ready to be used in VirtualBox.
    
3. **Set up the VM in VirtualBox.**
From the **Machine** tab, click **New** to create a new virtual machine.
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-5.webp)
    
    Name the VM and select the Windows 10 ISO image you downloaded earlier.
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-6.webp)
    
    According to the [Flare-VM requirements](https://github.com/mandiant/flare-vm#requirements), at least 2 GB of memory is needed. Based on your system specs, allocate 4–8 GB. For processors, assign at least 2 CPUs.
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-7.webp)
    
    For the **Hard Disk**, allocate at least 60 GB (80 GB recommended). Save the configuration and start the VM. If you run into boot problems, power off the VM, go to **Settings > Display**, and enable **3D Acceleration**.
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-8.webp)
    

1. **Take Snapshots**
    
    To take a snapshot of the current VM state, go to the **Snapshots** tab on the right side of the VM details.
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-9.webp)
    
    And then click the "Take" icon.
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S1/S1-10.webp)
    
    In this lab, we will take four snapshots:  
    
    1. Base machine, before making any changes.
    2. After disabling Windows Defender (policies and configurations).
    3. After installing Flare-VM.
    4. After installing the tools required for dynamic malware analysis.

## Disabling Windows Defender

- **Disable Windows Update**
    - Press `Windows + R`, type `services.msc`, then locate the **Windows Update** service and stop it.
        
        ![Alt](/images/SettingUpMalwareAnalysisLab/S2/S2-1.webp)
        

- **Disable Windows Security**
    - Windows Security Settings. In the search bar, type *Windows Security*, then go to **Virus & Threat Protection > Manage Settings**, and turn off **Real-time protection**.

![Alt](/images/SettingUpMalwareAnalysisLab/S2/S2-2.webp)

- **Local Group Policy**
    - Press Windows + R and type `gpedit.msc`
    - Navigate to **Local Computer Policy > Administrative Templates > Windows Components > Windows Defender Antivirus > Real-time Protection**.
    - Enable the **Turn off real-time protection** policy.
        
        ![Alt](/images/SettingUpMalwareAnalysisLab/S2/S2-3.webp)
        
    - Reboot the system
- **Diable Hide Extension**
    - Open File Explorer > **View**, then check **Hidden items** (to view hidden files/folders) and check **File name extensions**.
    - By default, Microsoft hides executable file extensions, which malware often abuses to masquerade as files like PDFs.
        
        ![Alt](/images/SettingUpMalwareAnalysisLab/S2/S2-4.webp)
        

## Installing Flare-VM

[**FLARE VM**](https://github.com/mandiant/flare-vm) is **a collection of software installation scripts for Windows systems that allows you to easily set up and maintain a reverse engineering environment on a virtual machine.** 

- Before installing Flare-VM, take a snapshot of the VM so you can revert to a clean state in case the installation fails.
- This tool takes longer to install because it automatically downloads and configures multiple analysis utilities.

[**Installation Instructions**](https://github.com/mandiant/flare-vm?tab=readme-ov-file#flare-vm-installation): Make sure all prerequisites are met.

1. Download and save this [PowerShell](https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1) script to a folder
2. Open PowerShell as administrator
3. Unlock the installation script 
    
    ```powershell
    Unblock-File .\install.ps1
    ```
    
4. Enable script execution 
    
    ```powershell
    Set-ExecutionPolicy Unrestricted -Force
    ```
    
5. Lastly, run the installer script 
    
    ```powershell
    .\install.ps1
    ```
    

After installation, it is recommended to switch the VM to **host-only networking mode** and take a new snapshot.

## Dynamic Malware Analysis

- **Sample names:** `e-Archive Dekont.exe` (original filename), copied to `VbxFiQYCyFDgGL.exe` on execution
- **MD5 Hash: 7a0093c743fc33a5e111f2fec269f79b**
- **SHA256 Hash: 722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088**
- **VirusTotal Report**: [722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088](https://www.virustotal.com/gui/file/722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088)

### Tools:

After Flare-VM installation, ensure that you have these tools installed, which will assist us in malware analysis. You can switch your VM network interface to NAT or download it from your host machine, then transfer it to the VM. 

- [HashMyFiles](https://www.nirsoft.net/utils/hash_my_files.html): a utility that allows you to calculate the hashes of one or more files in your system
- [Reghshot](https://sourceforge.net/projects/regshot/): It is a registry compare utility that allows you to quickly take a snapshot of your registry and then compare it with a second one
- [FakeNet](https://sourceforge.net/projects/fakenet/): it is a tool that is used to simulate the internet, which is useful in malware analysis.
- [process hacker](https://sourceforge.net/projects/processhacker/)
- [process monitor](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon)
- [sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)
    
    ```powershell
    # install sysmon zip file
    # install the configuration file on the vm and save it to C:\Windows\config.xml
    Invoke-WebRequest -Uri https://raw.githubusercontent.com/olafhartong/sysmon-modular/master/sysmonconfig.xml -OutFile C:\Windows\config.xml
    
    # then open powershell command-line as administrator and install sysmon with the configuration file we downloaded
    .\Sysmon64.exe  -accepteula -i C:\Windows\config.xml
    ```
    
- **Wireshark** → to open the pcap files generated from the execution of fakenet

Once finished, take a snapshot and save it for the **dynamic malware analysis labs** so you won’t have to redownload these tools after reverting any changes made by the malware. 

![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-1.webp)

### Preparation

1. **Download the Malware Sample**
    
    Download the Malware Sample from the [MalwareBazaar](https://bazaar.abuse.ch/sample/722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088/) website, then transfer it to your VM by enabling the shared folders and checking the **Auto-mount** option (the shared folder must be on the same drive as the ISO file). **The malware will be downloaded as a zip file with password protection, so it is safe to download as long as you don't extract it and execute it on your host machine**. 
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-2.webp)
    
    You should see the shared folder in your VM now
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-3.webp)
    
    After you transfer the malware sample archive, change the permissions of the shared folder to **Read-only** or delete the shared folder from the VM settings. 
    
2. **Network Interface Settings**
    
    Next, set the VM network adapter to **Host-only Adapter** and enable the **Cable Connected** option. This gives the VM a private Ethernet interface that Fakenet can bind to. 
    
    ![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-4.webp)
    
    This way, **malware will be isolated from the Internet but allowed to use network stacks.**
    

1. **Clear Sysmon events**
2. **Set up FakeNet (MITM for network capture & decryption):** Before executing `fakenet.exe`, import FakeNet’s CA certificate from the `configs` folder into the guest VM’s **Trusted Root Certification Authorities (LocalMachine\Root)** so FakeNet can act as an active MITM and decrypt TLS traffic. When the FakeNet CA is trusted by the guest OS, FakeNet can either write decrypted HTTP(s) data to its logs or produce PCAPs that include decrypted traffic.
    
    ```powershell
    Import-Certificate -FilePath "C:\Tools\fakenet\fakenet3.5\fakenet3.5\configs\fakenet_ca.crt" -CertStoreLocation Cert:\LocalMachine\Root
    ```
    
    Then run **fakenet.exe** with administrator privileges
    
3. **Prep the Process Hacker and Procmon to catch the malware execution**

### **Analyze**

Time of execution `10/05/2025 1:45:11 AM`

**Process Activity**——————————————

Once executed, Process Hacker briefly shows the sample, but the malware quickly terminates itself after spawning child processes. Because Process Hacker only displays currently running processes, use Procmon to view both terminated and active processes.  

![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-5.webp)

In **Procmon**, press the **"Show Process Tree"** button in the top menu to view the parent-child processes in a tree format. As you can see, the malware spawned two processes, `powershell.exe` and `schtask.exe`, then it terminated itself

![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-6.webp)

The command from the `powershell.exe` process:

```powershell
Add-MpPreference -ExclusionPath "C:\Users\Aisha\AppData\Roaming\VbxFiQYCyFDgGL.exe"
```

This adds the file to Microsoft Defender’s exclusion list, preventing real-time and scheduled scans from detecting that binary. The hash of the copied binary matches the malware sample. 

```powershell
PS C:\Users\Aisha> Get-FileHash -Algorithm sha256 C:\Users\Aisha\AppData\Roaming\VbxFiQYCyFDgGL.exe

Algorithm       Hash                                                                   Path
---------       ----                                                                   ----
SHA256          722EF401E5CBB067C5C33FAA402774D3C75EF08E0C8CC4D7E66A9CFA53684088       C:\Users\Aisha\AppData\Roaming\VbxFiQYCyFDgGL.exe
```

The scheduled-task child created persistence:

```
CommandLine: "C:\Windows\System32\schtasks.exe" /Create /TN "Updates\VbxFiQYCyFDgGL" /XML "C:\Users\Aisha\AppData\Local\Temp\tmp252B.tmp"
```

The **schtasks.exe** creates a new task named “`Updates\VbxFiQYCyFDgGL`". You can verify the task by: 

```powershell
schtasks.exe /QUERY /TN "Updates\VbxFiQYCyFDgGL" /FO LIST /V
```

![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-7.webp)

This task is configured to run the malware located at “`C:\Users\Aisha\AppData\Roaming\VbxFiQYCyFDgGL.exe`” at startup, confirming persistence. 

**Registry Activity**——————————————

In the sysmon, a registry value set was captured ([Event ID 13](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/))

![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-8.webp)

This event shows `svchost.exe` (running as SYSTEM) wrote a new registry value under the Task Schedule’s TaskCache, which indicates that the malware established a persistence via a scheduled task. 

**File Activity**——————————————

Sysmon captured file creation activity (Event ID 11) made by the malware under the **Updates** folder and also under the **AppData** folder

![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-9.webp)

![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-10.webp)

**Network Activity**——————————————

Let Fakenet run for a while to ensure it captures the network activity made by the malware, then stop it by pressing (Ctrl+C) to flush and save the pcap file and logs. 

![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-11.webp)

Opening the PCAP in Wireshark shows a DNS query for the malicious domain, followed by an HTTP POST to that host: `http[:]//5gw4d[.]xyz/PL341/index.php`

![Alt](/images/SettingUpMalwareAnalysisLab/S4/S4-12.webp)

### **Artifacts**

- SHA256: `722EF401E5CBB067C5C33FAA402774D3C75EF08E0C8CC4D7E66A9CFA53684088`
- Filenames: `e-Archive Dekont.exe`, `VbxFiQYCyFDgGL.exe`
- Domain: `5gw4d[.]xyz`
- URL: `http[:]//5gw4d[.]xyz/PL341/index.php`
- Scheduled task: `Updates\VbxFiQYCyFDgGL`
- PowerShell command: `Add-MpPreference -ExclusionPath "<path>"`

### Conclusion:

The dynamic analysis of the malware sample `e-Archive Dekont.exe` revealed that the malware primarily focuses on persistence and defense evasion. Upon execution, it copied itself to the **AppData\Roaming** directory with a random name, and created a scheduled task (`Updates\VbxFiQYCyFDgGL` ) to ensure automatic execution at the system startup. It also disables Windows Defender protection by adding itself to the exclusion list. As for the network traffic captured by Fakenet.exe, it showed that the malware attempts to communicate with a C2 server hosted at  `5gw4d[.]xyz` , likely to exfiltrate data or receive further commands.
